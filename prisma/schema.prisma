// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CLIENT
  TRAINER
  ADMIN
}

enum ClientStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum EmotionalState {
  MUY_BIEN
  BIEN
  NORMAL
  CANSADO
  AGOTADO
}

enum NutritionGoal {
  FAT_LOSS
  MUSCLE_GAIN
  MAINTENANCE
  HEALTH
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  role          Role      @default(CLIENT)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Campos nuevos para clientes
  status            ClientStatus @default(ACTIVE)
  age               Int?
  gender            Gender?
  height            Float? // cm
  initialWeight     Float? // kg
  goal              String?
  clinicalNotes     String? // intolerancias, alergias
  nextReviewDate    DateTime?

  // Campos nuevos para nutricionistas
  phone             String?
  specialty         String?
  licenseNumber     String?
  logoUrl           String?
  primaryColor      String? // hex color
  timezone          String?
  notificationsOn   Boolean @default(true)

  // Relaciones cuando es CLIENT
  nutritionPlan NutritionPlan[]
  trainingPlan  TrainingPlan[]
  weightEntry   WeightEntry[]
  files         File[]
  workoutSessions WorkoutSession[]
  bodyMeasurements BodyMeasurement[]
  nutritionistComments NutritionistComment[]
  reviews Review[]
  notifications Notification[] @relation("UserNotifications")
  clientWorkoutLogs ClientWorkoutLog[]

  // Relaciones cuando es TRAINER
  clients       User[]    @relation("TrainerClients")
  trainer       User?     @relation("TrainerClients", fields: [trainerId], references: [id])
  trainerId     String?

  @@index([email])
  @@index([trainerId])
  @@index([status])
  @@index([nextReviewDate])
}

model NutritionPlan {
  id          String    @id @default(cuid())
  title       String
  description String?
  pdfUrl      String
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Campos nuevos
  goal          NutritionGoal?
  calories      Int?
  protein       Float?
  carbs         Float?
  fats          Float?
  observations  String?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  @@index([userId])
  @@index([isActive])
}

model TrainingPlan {
  id          String    @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Campos nuevos
  trainerNotes String?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  weeks       TrainingWeek[]

  @@index([userId])
  @@index([isActive])
}

model TrainingWeek {
  id              String    @id @default(cuid())
  weekNumber      Int
  startDate       DateTime
  endDate         DateTime
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  trainingPlan    TrainingPlan @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)
  trainingPlanId  String
  sessions        TrainingSession[]

  @@index([trainingPlanId])
  @@index([weekNumber])
}

model TrainingSession {
  id              String    @id @default(cuid())
  dayNumber       Int       // 1-5
  name            String
  description     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  week            TrainingWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)
  weekId          String
  exercises       Exercise[]
  workoutSessions WorkoutSession[]

  @@index([weekId])
}

model Exercise {
  id              String    @id @default(cuid())
  name            String
  description     String?   // Explicación técnica de ejecución
  videoUrl        String?   // Enlace a vídeo
  targetSets      String?   // Series objetivo (ej: "3 x 12-10-8")
  trainerComment  String?   // Comentario del entrenador
  order           Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  session         TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId       String
  exerciseData    ExerciseData[]
  clientWorkoutLogs ClientWorkoutLog[]

  @@index([sessionId])
}

// Datos de un ejercicio en una sesión completada
model ExerciseData {
  id          String    @id @default(cuid())
  reps        Int
  weight      Float
  rir         Int       // Repeticiones en reserva
  notes       String?
  createdAt   DateTime  @default(now())

  exercise    Exercise  @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  exerciseId  String

  workoutSession WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  workoutSessionId String

  @@index([exerciseId])
  @@index([workoutSessionId])
}

// Sesión de entrenamiento completada
model WorkoutSession {
  id              String    @id @default(cuid())
  completedAt     DateTime  @default(now())
  emotionalState  EmotionalState
  fatigueLevel    Int       // 1-10
  waterIntake     Float     // litros
  notes           String?

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String

  session         TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId       String

  exerciseData    ExerciseData[]

  @@index([userId])
  @@index([sessionId])
  @@index([completedAt])
}

// Registro del cliente por ejercicio, semana/microciclo y serie
// Este modelo es SOLO editable por el cliente
model ClientWorkoutLog {
  id              String    @id @default(cuid())
  weekNumber      Int       // Semana/microciclo (1, 2, 3, 4...)
  setNumber       Int       // Número de serie (1, 2, 3...)
  reps            Int?      // Repeticiones reales realizadas
  weight          Float?    // Peso real utilizado
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relación con el ejercicio del plan del entrenador (solo lectura)
  exercise        Exercise  @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  exerciseId      String

  // Cliente que registra
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String

  @@unique([exerciseId, userId, weekNumber, setNumber])
  @@index([exerciseId])
  @@index([userId])
  @@index([weekNumber])
}

model WeightEntry {
  id          String    @id @default(cuid())
  weight      Float
  date        DateTime
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  @@index([userId])
  @@index([date])
}

enum FileType {
  PDF
  IMAGE
  VIDEO
  OTHER
}

model File {
  id          String    @id @default(cuid())
  name        String
  type        FileType
  url         String
  size        Int
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  @@index([userId])
  @@index([type])
}

model Notification {
  id          String    @id @default(cuid())
  title       String
  message     String
  type        String    // 'workout', 'photos', 'weight', etc.
  read        Boolean   @default(false)
  scheduledFor DateTime?
  sentAt      DateTime?
  createdAt   DateTime  @default(now())

  user        User      @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  @@index([userId])
  @@index([read])
  @@index([scheduledFor])
}

model BodyMeasurement {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime
  weight    Float?
  chest     Float? // pecho
  waist     Float? // cintura
  hips      Float? // cadera
  arms      Float? // brazos
  legs      Float? // piernas
  notes     String?
  createdAt DateTime @default(now())

  @@index([userId, date])
}

model NutritionistComment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment   String
  createdAt DateTime @default(now())
  trainerId String

  @@index([userId, createdAt])
}

model Review {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trainerId       String
  reviewDate      DateTime
  changes         String // qué se modificó
  notes           String?
  nextReviewDate  DateTime?
  createdAt       DateTime @default(now())

  @@index([userId, reviewDate])
  @@index([trainerId, nextReviewDate])
}
