// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CLIENT
  TRAINER
  ADMIN
}

enum ClientStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum EmotionalState {
  MUY_BIEN
  BIEN
  NORMAL
  CANSADO
  AGOTADO
}

enum NutritionGoal {
  FAT_LOSS
  MUSCLE_GAIN
  MAINTENANCE
  HEALTH
}

enum MuscleGroup {
  UPPER_BODY
  LOWER_BODY
  CORE
  FULL_BODY
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  role          Role      @default(CLIENT)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Campos nuevos para clientes
  status            ClientStatus @default(ACTIVE)
  age               Int?
  gender            Gender?
  height            Float? // cm
  initialWeight     Float? // kg
  goal              String?
  clinicalNotes     String? // intolerancias, alergias
  nextReviewDate    DateTime?

  // Campos nuevos para nutricionistas
  phone             String?
  specialty         String?
  licenseNumber     String?
  logoUrl           String?
  primaryColor      String? // hex color
  timezone          String?
  notificationsOn   Boolean @default(true)

  // Relaciones cuando es CLIENT
  nutritionPlan NutritionPlan[]
  weightEntry   WeightEntry[]
  files         File[]
  bodyMeasurements BodyMeasurement[]
  nutritionistComments NutritionistComment[]
  reviews Review[]
  notifications Notification[] @relation("UserNotifications")

  // NUEVAS relaciones para sistema de templates y mesociclos
  trainingTemplates     TrainingTemplate[] @relation("TrainerTemplates")
  clientMesocycles      ClientMesocycle[]  @relation("ClientMesocycles")
  trainerMesocycles     ClientMesocycle[]  @relation("TrainerMesocycles")

  // Relaciones cuando es TRAINER
  clients       User[]    @relation("TrainerClients")
  trainer       User?     @relation("TrainerClients", fields: [trainerId], references: [id])
  trainerId     String?

  @@index([email])
  @@index([trainerId])
  @@index([status])
  @@index([nextReviewDate])
}

model NutritionPlan {
  id          String    @id @default(cuid())
  title       String
  description String?
  pdfUrl      String
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Campos nuevos
  goal          NutritionGoal?
  calories      Int?
  protein       Float?
  carbs         Float?
  fats          Float?
  observations  String?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  @@index([userId])
  @@index([isActive])
}

// ============================================================================
// NUEVOS MODELOS: SISTEMA DE TEMPLATES Y MESOCICLOS
// ============================================================================

// 1. PLANTILLAS (Semana Tipo - Reutilizable)

model TrainingTemplate {
  id              String    @id @default(cuid())
  trainerId       String
  title           String
  description     String?
  numberOfDays    Int       @default(5)  // 3-5 days
  trainerNotes    String?
  isArchived      Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  trainer         User      @relation("TrainerTemplates", fields: [trainerId], references: [id], onDelete: Cascade)
  days            TemplateDay[]
  mesocycles      ClientMesocycle[]

  @@index([trainerId])
  @@index([isArchived])
}

model TemplateDay {
  id              String    @id @default(cuid())
  templateId      String
  dayNumber       Int       // 1-5
  name            String    // "Día 1 - Pecho/Tríceps"
  description     String?
  order           Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  template        TrainingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  exercises       Exercise[]
  workoutDayLogs  WorkoutDayLog[]

  @@unique([templateId, dayNumber])
  @@index([templateId])
}

model Exercise {
  id              String       @id @default(cuid())
  templateDayId   String
  name            String
  description     String?
  videoUrl        String?
  trainerComment  String?
  order           Int
  muscleGroup     MuscleGroup  @default(UPPER_BODY)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  templateDay     TemplateDay  @relation(fields: [templateDayId], references: [id], onDelete: Cascade)
  sets            ExerciseSet[]
  exerciseLogs    ExerciseLog[]

  @@index([templateDayId])
  @@index([order])
}

model ExerciseSet {
  id              String    @id @default(cuid())
  exerciseId      String
  setNumber       Int
  minReps         Int
  maxReps         Int
  restSeconds     Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  exercise        Exercise  @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([exerciseId, setNumber])
  @@index([exerciseId])
}

// 2. MESOCICLOS (Asignación Temporal + Registro)

model ClientMesocycle {
  id                String    @id @default(cuid())
  clientId          String
  templateId        String
  trainerId         String

  startDate         DateTime
  durationWeeks     Int       @default(20)
  endDate           DateTime

  isActive          Boolean   @default(true)
  isCompleted       Boolean   @default(false)
  completedAt       DateTime?

  trainerNotes      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  client            User      @relation("ClientMesocycles", fields: [clientId], references: [id], onDelete: Cascade)
  template          TrainingTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  trainer           User      @relation("TrainerMesocycles", fields: [trainerId], references: [id], onDelete: Cascade)
  microcycles       Microcycle[]

  @@index([clientId])
  @@index([trainerId])
  @@index([isActive])
  @@index([templateId])
}

model Microcycle {
  id              String    @id @default(cuid())
  mesocycleId     String
  weekNumber      Int       // 1-20
  startDate       DateTime
  endDate         DateTime
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  mesocycle       ClientMesocycle @relation(fields: [mesocycleId], references: [id], onDelete: Cascade)
  workoutDayLogs  WorkoutDayLog[]

  @@unique([mesocycleId, weekNumber])
  @@index([mesocycleId])
  @@index([startDate])
}

model WorkoutDayLog {
  id              String    @id @default(cuid())
  microcycleId    String
  templateDayId   String

  completedDate   DateTime
  durationMinutes Int?
  rpe             Int?      // 1-10
  fatigue         Int?      // 1-10
  emotionalState  EmotionalState?
  clientNotes     String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  microcycle      Microcycle @relation(fields: [microcycleId], references: [id], onDelete: Cascade)
  templateDay     TemplateDay @relation(fields: [templateDayId], references: [id], onDelete: Restrict)
  exerciseLogs    ExerciseLog[]

  @@index([microcycleId])
  @@index([templateDayId])
  @@index([completedDate])
}

model ExerciseLog {
  id              String    @id @default(cuid())
  workoutDayLogId String
  exerciseId      String

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  workoutDayLog   WorkoutDayLog @relation(fields: [workoutDayLogId], references: [id], onDelete: Cascade)
  exercise        Exercise  @relation(fields: [exerciseId], references: [id], onDelete: Restrict)
  setLogs         SetLog[]

  @@index([workoutDayLogId])
  @@index([exerciseId])
}

model SetLog {
  id              String    @id @default(cuid())
  exerciseLogId   String
  setNumber       Int
  reps            Int
  weight          Float
  rir             Int?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  exerciseLog     ExerciseLog @relation(fields: [exerciseLogId], references: [id], onDelete: Cascade)

  @@unique([exerciseLogId, setNumber])
  @@index([exerciseLogId])
}

// ============================================================================
// MODELOS EXISTENTES (Sin cambios)
// ============================================================================

model WeightEntry {
  id          String    @id @default(cuid())
  weight      Float
  date        DateTime
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  @@index([userId])
  @@index([date])
}

enum FileType {
  PDF
  IMAGE
  VIDEO
  OTHER
}

model File {
  id          String    @id @default(cuid())
  name        String
  type        FileType
  url         String
  size        Int
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  @@index([userId])
  @@index([type])
}

model Notification {
  id          String    @id @default(cuid())
  title       String
  message     String
  type        String    // 'workout', 'photos', 'weight', etc.
  read        Boolean   @default(false)
  scheduledFor DateTime?
  sentAt      DateTime?
  createdAt   DateTime  @default(now())

  user        User      @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  @@index([userId])
  @@index([read])
  @@index([scheduledFor])
}

model BodyMeasurement {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime
  weight    Float?
  chest     Float? // pecho
  waist     Float? // cintura
  hips      Float? // cadera
  arms      Float? // brazos
  legs      Float? // piernas
  notes     String?
  createdAt DateTime @default(now())

  @@index([userId, date])
}

model NutritionistComment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment   String
  createdAt DateTime @default(now())
  trainerId String

  @@index([userId, createdAt])
}

model Review {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trainerId       String
  reviewDate      DateTime
  changes         String // qué se modificó
  notes           String?
  nextReviewDate  DateTime?
  createdAt       DateTime @default(now())

  @@index([userId, reviewDate])
  @@index([trainerId, nextReviewDate])
}
